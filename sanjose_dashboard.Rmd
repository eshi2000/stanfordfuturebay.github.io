---
title: "San Jose Social Distancing Compliance"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
---

<style>
.datatables{
    overflow: auto;
}
</style>

```{r global, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(leaflet)
library(plotly)
library(sf)
library(DT)

# Keeping this data private, per Safegraph's request. Will need to publish the dashboard again with every new data update.
sj_percenthome_bg <- readRDS("sj_percenthome_bg.rds")

# sj_blockgroups <- readRDS(gzcon(url("https://github.com/stanfordfuturebay/stanfordfuturebay.github.io/blob/master/data/sj_blockgroups.rds?raw=true")))
sj_blockgroups <- readRDS("sj_blockgroups.rds")

# sj_citycouncil_districts <- readRDS(gzcon(url("https://github.com/stanfordfuturebay/stanfordfuturebay.github.io/blob/master/data/sj_citycouncil_districts.rds?raw=true")))
sj_citycouncil_districts <- readRDS("sj_citycouncil_districts.rds")

weekends <-
  sj_percenthome_bg %>% 
  filter(!duplicated(date)) %>% 
  arrange(date) %>% 
  mutate(
    x = 
      case_when(
        (date %>% as.numeric()) %% 7 == 1 ~ date + 1,
        (date %>% as.numeric()) %% 7 == 4 ~ date - 1,
        TRUE ~ date
      ),
    y = 
      ifelse(
        (date %>% as.numeric()) %% 7 %in% c(2,3),
        1000,
        0
      )
  ) %>% 
  dplyr::select(x,y)

block_Ids <-
  sj_percenthome_bg %>% 
  pull(origin_census_block_group) %>% 
  as.character() %>% 
  unique()

district_Ids <- 1:10 %>% as.character()

blue_pal <- colorNumeric(
  palette = "Blues",
  domain = 
    c(0,sj_percenthome_bg %>% 
    pull(`% Leaving Home`) %>% 
    unique())
)

# parks loading
all_parks <- read_rds('park_output.rds')

#parks geometry (to join to all_parks in the leaflet)
all_parks_geometry <- read_rds('park_output_geometry.rds')

# sj_boundary <- readRDS(gzcon(url("https://github.com/stanfordfuturebay/stanfordfuturebay.github.io/blob/master/data/sj_boundary.rds?raw=true")))
sj_boundary <- readRDS("sj_boundary.rds")

sj_centroid <-
  sj_boundary %>% 
  st_centroid() %>% 
  st_coordinates()

park_Ids <- paste0("park",1:nrow(all_parks))

green_pal <- colorNumeric(
  palette = "Greens",
  domain = 
    c(0,all_parks %>% 
    pull(visit_counts) %>% 
    unique())
)

#demographics loading
sj_dem_distancing_combined <- readRDS("sj_socialdistancing_demdata_prepost.rds")
```

Home
===================================== 

Inputs {.sidebar}
-----------------------------------------------------------------------

Use the buttons on the header to navigate to other pages of the dashboard. See more information at the [Dashboard FAQ](https://stanfordfuturebay.github.io/sanjose_faq.html). Data courtesy of [Safegraph](https://www.safegraph.com/covid-19-data-consortium).

```{r}
sliderInput(
  "date", 
  label = "Date:",
  min = min(sj_percenthome_bg$date),
  max = max(sj_percenthome_bg$date),
  value = max(sj_percenthome_bg$date),
  timeFormat = "%m/%d"
)

radioButtons(
  "districts",
  "District to highlight on map and chart:",
  c(
    "None" = "",
    "District 1" = "1",
    "District 2" = "2",
    "District 3" = "3",
    "District 4" = "4",
    "District 5" = "5",
    "District 6" = "6",
    "District 7" = "7",
    "District 8" = "8",
    "District 9" = "9",
    "District 10" = "10"
  ),
  selected = ""
)
```

Column
-----------------------------------------------------------------------

### Percent of People Leaving Home in San Jose, by Block Group {data-height=650}

```{r}
leafletOutput("map")
```

```{r, context="server"}
output$map <- renderLeaflet({
  
  leaflet() %>% 
    addProviderTiles(providers$CartoDB.Positron) %>% 
    addMapPane("blocks", 410) %>% 
    addMapPane("districts", 420) %>% 
    addLegend(
      data = sj_percenthome_bg,
      pal = blue_pal,
      values = ~`% Leaving Home`,
      title = "% Leaving<br>Home",
      opacity = 0.5
    ) %>% 
    setView(-121.87,37.30,10)
})

outputOptions(output, "map", priority = 14, suspendWhenHidden = F)
```

```{r, context="server"}
observeEvent(input$date,{
  
  leafletProxy("map") %>% 
    addPolygons(
      data = sj_percenthome_bg %>% 
        filter(date == input$date) %>% 
        left_join(sj_blockgroups, by ="origin_census_block_group") %>%
        st_as_sf(),
      layerId = block_Ids,
      fillColor = ~blue_pal(`% Leaving Home`),
      color = "white",
      weight = 0.5,
      opacity = 0.5,
      fillOpacity = 0.5,
      label = ~paste0(`% Leaving Home`,"% leaving home"),
      highlightOptions = 
        highlightOptions(
          weight = 2.25,
          opacity = 1
        ),
      options = 
        pathOptions(
          pane = "blocks"
        )
    ) %>% 
    addPolygons(
      data = 
        sj_citycouncil_districts %>% 
        filter(id == isolate(input$districts)),
      layerId = district_Ids,
      fill = F,
      color = "rgb(245,118,38)",
      weight = 2,
      opacity = 1,
      label = isolate(input$districts),
      highlightOptions = 
        highlightOptions(
          weight = 2.5,
          opacity = 1
        ),
      options = 
        pathOptions(
          pane = "districts"
        )
    )
}, once = T, priority = 13)
```

```{r, context="server"}
observeEvent(input$date,{

  leafletProxy("map") %>% 
    addPolygons(
      data = sj_percenthome_bg %>% 
        filter(date == isolate(input$date)) %>% 
        left_join(sj_blockgroups, by ="origin_census_block_group") %>%
        st_as_sf(),
      layerId = block_Ids,
      fillColor = ~blue_pal(`% Leaving Home`),
      color = "white",
      weight = 0.5,
      opacity = 0.5,
      fillOpacity = 0.5,
      label = ~paste0(`% Leaving Home`,"% leaving home"),
      highlightOptions = 
        highlightOptions(
          weight = 2.25,
          opacity = 1
        ),
      options = 
        pathOptions(
          pane = "blocks"
        )
    )
  
}, ignoreInit = T, priority = 7)
```

```{r, context="server"}
observeEvent(input$districts,{
  
  leafletProxy("map") %>%
    removeShape(district_Ids) %>%
    addPolygons(
      data =
        sj_citycouncil_districts %>%
        filter(id %in% input$districts),
      layerId = district_Ids,
      fill = F,
      color = "rgb(245,118,38)",
      weight = 2,
      opacity = 1,
      label = input$districts,
      highlightOptions = 
        highlightOptions(
          weight = 2.25,
          opacity = 1
        ),
      options = 
        pathOptions(
          pane = "districts"
        )
    )
}, ignoreInit = T, priority = 6)
```

Column
-----------------------------------------------------------------------

### Percent of People Leaving Home in San Jose, by Date {data-height=500}

```{r}
plotlyOutput("graph")
```

```{r, context="server"}
output$graph <- renderPlotly({
  
  data <-
    unique(sj_percenthome_bg$date) %>% 
    map_dfr(function(specificdate){
      
      sj_percenthome_bg_altered <-
        sj_percenthome_bg %>% 
        filter(date == specificdate)
      
      data.frame(
        date = specificdate,
        mean_percenthome = round(mean(sj_percenthome_bg_altered$`% Leaving Home`),digits = 1),
        sd_percenthome = round(sd(sj_percenthome_bg_altered$`% Leaving Home`),digits = 1)
      )
    }) %>% 
    arrange(date)

  plot_ly(
    data = data,
    x = ~date
  ) %>% 
    add_trace(
      x = weekends$x,
      y = weekends$y,
      type = "scatter",
      mode = "lines",
      fill = "tozeroy",
      fillcolor = "rgba(112,112,112,0.25)",
      line = list(color = "transparent"),
      name = "Weekends",
      showlegend=T
    ) %>% 
    add_trace(
      x = c("2020-03-16" %>% as.Date(),"2020-03-16" %>% as.Date()),
      y = c(-10,110),
      type = "scatter",
      mode = "lines",
      line = list(color = "rgb(63,63,63)",dash = "dot"),
      name = "Santa Clara County Shelter-in-Place Order",
      showlegend=F
    ) %>% 
    add_trace(
      y = ~mean_percenthome-sd_percenthome,
      type = "scatter",
      mode = "lines",
      line = list(color = "transparent"),
      name = "City, +/- 1 S.D.",
      showlegend=F
    ) %>% 
    add_trace(
      y = ~mean_percenthome+sd_percenthome,
      type = "scatter",
      mode = "lines",
      fill = "tonexty",
      fillcolor = "rgba(39,128,227,0.25)",
      line = list(color = "transparent"),
      name = "City, +/- 1 S.D.",
      showlegend=T
    ) %>% 
    add_trace(
      y = ~mean_percenthome,
      type = "scatter",
      mode = "lines",
      line = list(color = "rgb(0,0,0)"),
      name = "City, Mean",
      showlegend=T
    ) %>% 
    add_trace(
      type = "scatter",
      mode = "lines",
      x = c(isolate(input$date),isolate(input$date)),
      y = c(-10,110),
      line = list(color = "rgb(39,128,227)"),
      name = "Current Map View",
      showlegend=F
    ) %>% 
    add_trace(
      type = "scatter",
      mode = "lines",
      x = c(isolate(input$date),isolate(input$date)),
      y = c(-10,110),
      line = list(color = "rgb(39,128,227)"),
      name = "Current Map View",
      showlegend=F
    ) %>% 
    layout(
      margin = list(t = 50),
      paper_bgcolor='rgb(255,255,255)', 
      plot_bgcolor='rgb(229,229,229)',
      xaxis = list(
        title = "",
        gridcolor = 'rgb(255,255,255)',
        showgrid = TRUE,
        showline = FALSE,
        showticklabels = TRUE,
        tickcolor = 'rgb(127,127,127)',
        ticks = 'outside',
        zeroline = FALSE,
        fixedrange = T,
        range = c(min(sj_percenthome_bg$date),max(sj_percenthome_bg$date)+1)
      ),
      yaxis = list(
        title = "Percent Leaving Home",
        gridcolor = 'rgb(255,255,255)',
        showgrid = TRUE,
        showline = FALSE,
        showticklabels = TRUE,
        tickcolor = 'rgb(127,127,127)',
        ticks = 'outside',
        zeroline = FALSE,
        fixedrange = T,
        range = c(0,100)
      ),
      annotations = list(
        xref = "x",
        yref = "y",
        x = "2020-03-16" %>% as.Date(),
        y = 100,
        text = "Santa Clara County<br>Shelter-in-Place Order"
      ),
      legend = list(
        x = 0.05, 
        y = 0.05,
        bgcolor = 'rgb(229,229,229)'
      )
    ) %>% 
    config(displayModeBar = F)
  
})

outputOptions(output, "graph", priority = 12, suspendWhenHidden = F)
```

```{r, context="server"}
observeEvent(input$districts,{
    
  if(input$districts == ""){
    
    plotlyProxy("graph") %>% 
      plotlyProxyInvoke("deleteTraces", list(5,6)) %>%
      plotlyProxyInvoke(
        "addTraces",
        list(
          type = "scatter",
          mode = "lines",
          x = c(isolate(input$date),isolate(input$date)),
          y = c(-10,110),
          line = list(color = "rgb(39,128,227)"),
          name = "Current Map View",
          showlegend=F
        )
      ) %>% 
      plotlyProxyInvoke(
        "addTraces",
        list(
          type = "scatter",
          mode = "lines",
          x = c(isolate(input$date),isolate(input$date)),
          y = c(-10,110),
          line = list(color = "rgb(39,128,227)"),
          name = "Current Map View",
          showlegend=F
        )
      )
    
  } else {
    
    district_data <-
      sj_percenthome_bg %>%
      filter(DISTRICTS %in% input$districts)
  
    district_data <-
      unique(district_data$date) %>%
      map_dfr(function(specificdate){
  
        sj_percenthome_bg_altered <-
          district_data %>%
          filter(date == specificdate)
  
        data.frame(
          date = specificdate,
          mean_percenthome = round(mean(sj_percenthome_bg_altered$`% Leaving Home`),digits = 1),
          sd_percenthome = round(sd(sj_percenthome_bg_altered$`% Leaving Home`),digits = 1)
        )
      })
  
    plotlyProxy("graph") %>% 
      plotlyProxyInvoke("deleteTraces", list(5,6)) %>%
      plotlyProxyInvoke(
        "addTraces",
        list(
          x = district_data$date,
          y = district_data$mean_percenthome,
          type = "scatter",
          mode = "lines",
          line = list(color = "rgb(245,118,38)"),
          name = paste0("District ",input$districts,", Mean"),
          showlegend=T
        )
      ) %>% 
      plotlyProxyInvoke(
        "addTraces",
        list(
          type = "scatter",
          mode = "lines",
          x = c(isolate(input$date),isolate(input$date)),
          y = c(-10,110),
          line = list(color = "rgb(39,128,227)"),
          name = "Current Map View",
          showlegend=F
        )
      )
    
  }

}, priority = 9)
```

```{r, context="server"}
observeEvent(input$date,{
  
  if(isolate(input$districts) == ""){
    
    plotlyProxy("graph") %>% 
      plotlyProxyInvoke("deleteTraces",  list(5,6)) %>% 
      plotlyProxyInvoke(
        "addTraces",
        list(
          type = "scatter",
          mode = "lines",
          x = c(input$date,input$date),
          y = c(-10,110),
          line = list(color = "rgb(39,128,227)"),
          name = "Current Map View",
          showlegend=F
        )
      ) %>% 
      plotlyProxyInvoke(
        "addTraces",
        list(
          type = "scatter",
          mode = "lines",
          x = c(input$date,input$date),
          y = c(-10,110),
          line = list(color = "rgb(39,128,227)"),
          name = "Current Map View",
          showlegend=F
        )
      )
    
  } else {
    
    plotlyProxy("graph") %>% 
      plotlyProxyInvoke("deleteTraces", 6) %>% 
      plotlyProxyInvoke(
        "addTraces",
        list(
          type = "scatter",
          mode = "lines",
          x = c(input$date,input$date),
          y = c(-10,110),
          line = list(color = "rgb(39,128,227)"),
          name = "Current Map View",
          showlegend=F
        )
      )
    
  }

}, priority = 8)
```

### Key Insights (Last Updated 5/1) {data-height=500}

<style>
ol ul {
    margin-bottom: 10px;
}
</style>

1. As of data up to April 27, the greatest city-wide compliance continues to be on Sunday April 5 (~41% leaving home). In the three weekends since this point, compliance has steadily worsened. The following are the percentages leaving home for four consecutive weekends:

   * Saturdays - April 4 (~45%) to April 11 (~51%) to April 18 (~51%) to April 25 (~51%)
   * Sundays - April 5 (~41%, peak) to April 12 (~44%) to April 19 (~48%) to April 26 (51%)
   
   Although there was not a significant shift in compliance on the past three Saturdays, the rate of compliance on Sundays has gone from noticeably better than Saturdays to the same as Saturdays. **It is now more apparent that Sunday compliance behavior is relaxing, and increased outreach/enforcement may be needed.**

2. With the addition of districts in the dashboard, we can now analyze the at-home behavior at more localized levels. The following categorizes whether a specific district has been below or above San Jose's average % leaving home since shelter-in-place:

   * Below average: District 1, District 4, District 8, District 10
   * Nearly Average: District 2, District 6, District 7 District 9
   * **Above Average: District 3, District 5**
   
   The above average districts have the least social distancing compliance and are potential areas to focus more outreach/enforcement measures.

Parks
=====================================

Inputs {.sidebar}
-----------------------------------------------------------------------

The following data are from [Safegraph](https://www.safegraph.com/covid-19-data-consortium) and are estimates based on a representative sample of devices (scaled up to full population visits using the "Scaling Factor"). See more information at the [Dashboard FAQ](https://stanfordfuturebay.github.io/sanjose_faq.html).

```{r}
sliderInput(
  "parkdate", 
  label = "Date:",
  min = min(all_parks$date),
  max = max(all_parks$date),
  value = max(all_parks$date),
  timeFormat = "%m/%d"
)

parkchoices <-
  c(
    "",
    all_parks$location_name %>% 
      unique() %>% 
      as.character() %>% 
      sort()
  )

selectizeInput(
  "parkselect", 
  label = "Highlight one park on map/chart:", 
  choices = parkchoices, 
  selected = "",
  multiple = FALSE,
  width = NULL, 
  size = 1,
  options = list(
    placeholder = "Type here"
  )
)

```

Column
-----------------------------------------------------------------------

### Map of Park Visits, by Date {data-height=500}

```{r}
leafletOutput("parkmap")
```

```{r, context="server"}
output$parkmap <- renderLeaflet({
  
  leaflet() %>% 
    addProviderTiles(providers$CartoDB.Positron) %>% 
    addPolygons(
      data = sj_boundary,
      fill = F,
      color = "gray",
      weight = 1,
      label = ~NAME
    )
})

outputOptions(output, "parkmap", priority = 11, suspendWhenHidden = F)
```

```{r, context="server"}
observeEvent(input$parkdate,{
  
  leafletProxy("parkmap") %>% 
    addPolygons(
      data = all_parks %>% 
        filter(date == input$parkdate) %>%
        left_join(
          all_parks_geometry,
          by = "safegraph_place_id"
        ) %>%
        st_as_sf() %>%
        st_transform(4326),
      layerId = park_Ids,
      fillColor = ~green_pal(visit_counts),
      color = "green",
      weight = 0.5,
      opacity = 0.5,
      fillOpacity = 0.5,
      label = ~paste0(location_name, ": ", round(visit_counts,-1)," total visits on day of ", date,"."),
      highlightOptions = 
        highlightOptions(
          weight = 2.25,
          opacity = 1
        )
    ) %>% 
    addPolygons(
      data = all_parks %>% 
        filter(date == input$parkdate) %>% 
        filter(location_name == isolate(input$parkselect)) %>% 
        left_join(
          all_parks_geometry,
          by = "safegraph_place_id"
        ) %>%
        st_as_sf() %>% 
        st_transform(4326),
      layerId = "parkselect",
      fill = F,
      color = "red",
      weight = 2,
      opacity = 1
    )
  
}, priority = 4)
```

```{r, context="server"}
observeEvent(input$parkselect,{
  
  if(input$parkselect != ""){
    
    coords <- all_parks %>% 
      filter(location_name == input$parkselect) %>% 
      .[1,] %>%
      left_join(
          all_parks_geometry,
          by = "safegraph_place_id"
        ) %>%
      st_as_sf() %>% 
      st_transform(4326) %>% st_centroid() %>% st_coordinates()
    
    leafletProxy("parkmap") %>% 
      addPolygons(
        data = all_parks %>% 
          filter(date == isolate(input$parkdate)) %>% 
          filter(location_name == input$parkselect) %>%
          left_join(
            all_parks_geometry,
            by = "safegraph_place_id"
          ) %>%
          st_as_sf() %>% 
          st_transform(4326),
        layerId = "parkselect",
        fill = F,
        color = "red",
        weight = 2,
        opacity = 1
      ) %>% 
      setView(lng = coords[1,1],lat = coords[1,2], zoom = 14)
    
  }
    
}, priority = 4)
```

### Table of Park Visits, by Date {data-height=500}

```{r}
dataTableOutput("parktable")
```

```{r, context="server"}
observeEvent(input$parkdate,{

  output$parktable <- renderDataTable(
    all_parks %>% 
      filter(date == input$parkdate) %>%
      transmute(
        Name = location_name,
        Visits = round(visit_counts,-1),
        `Visits per Acre` = round(Visits_Acre,-1),
        `Scaling Factor` = round(ratio)
      ) %>% 
      arrange(desc(Visits),desc(`Visits per Acre`)) %>% 
      filter(!duplicated(Name)),
    options = list(
      pageLength = 10,
      order = list(2,'dsc'),
      dom = 'tp'
    )
  )
  
  outputOptions(output, "parktable", priority = 20, suspendWhenHidden = F)
  
}, priority = 20)
```

Column
-----------------------------------------------------------------------

### Daily Park Visits in San Jose, by Date {data-height=500}

```{r}
plotlyOutput("parkgraph")
```

```{r, context="server"}
output$parkgraph <- renderPlotly({
  
  data <-
    unique(all_parks$date) %>% 
    map_dfr(function(specificdate){
      
      all_parks_altered <-
        all_parks %>% 
        filter(date == specificdate)
      
      data.frame(
        date = specificdate,
        mean_visit_counts = round(mean(all_parks_altered$visit_counts),digits = 1),
        sd_visit_counts = round(sd(all_parks_altered$visit_counts),digits = 1)
      )
    })

  plot_ly(
    data = data,
    x = ~date
  ) %>% 
    add_trace(
      x = weekends$x,
      y = weekends$y,
      type = "scatter",
      mode = "lines",
      fill = "tozeroy",
      fillcolor = "rgba(112,112,112,0.25)",
      line = list(color = "transparent"),
      name = "Weekends",
      showlegend=T
    ) %>% 
    add_trace(
      x = c("2020-03-16" %>% as.Date(),"2020-03-16" %>% as.Date()),
      y = c(-10,1010),
      type = "scatter",
      mode = "lines",
      line = list(color = "rgb(63,63,63)",dash = "dot"),
      name = "Santa Clara County Shelter-in-Place Order",
      showlegend=F
    ) %>% 
    add_trace(
      x = c("2020-03-20" %>% as.Date(),"2020-03-20" %>% as.Date()),
      y = c(-10,1010),
      type = "scatter",
      mode = "lines",
      line = list(color = "rgb(63,63,63)",dash = "dot"),
      name = "Playground Closures",
      showlegend=F
    ) %>% 
    add_trace(
      x = c("2020-04-01" %>% as.Date(),"2020-04-01" %>% as.Date()),
      y = c(-10,1010),
      type = "scatter",
      mode = "lines",
      line = list(color = "rgb(63,63,63)",dash = "dot"),
      name = "Park Amenity Closures",
      showlegend=F
    ) %>% 
    add_trace(
      x = c("2020-04-08" %>% as.Date(),"2020-04-08" %>% as.Date()),
      y = c(-10,1010),
      type = "scatter",
      mode = "lines",
      line = list(color = "rgb(63,63,63)",dash = "dot"),
      name = "Park and Parking Lot Closures",
      showlegend=F
    ) %>% 
    add_trace(
      y = ~mean_visit_counts-sd_visit_counts,
      type = "scatter",
      mode = "lines",
      line = list(color = "transparent"),
      name = "City, +/- 1 S.D.",
      showlegend=F
    ) %>% 
    add_trace(
      y = ~mean_visit_counts+sd_visit_counts,
      type = "scatter",
      mode = "lines",
      fill = "tonexty",
      fillcolor = "rgba(31,164,99,0.25)",
      line = list(color = "transparent"),
      name = "City, +/- 1 S.D.",
      showlegend=T
    ) %>% 
    add_trace(
      y = ~mean_visit_counts,
      type = "scatter",
      mode = "lines",
      line = list(color = "rgb(0,0,0)"),
      name = "City, Mean",
      showlegend=T
    ) %>% 
    add_trace(
      type = "scatter",
      mode = "lines",
      x = c(max(all_parks$date),max(all_parks$date)),
      y = c(-10,1010),
      line = list(color = "rgb(39,128,227)"),
      name = "Current Map View",
      showlegend=F
    ) %>% 
    add_trace(
      type = "scatter",
      mode = "lines",
      x = c(max(all_parks$date),max(all_parks$date)),
      y = c(-10,1010),
      line = list(color = "rgb(39,128,227)"),
      name = "Current Map View",
      showlegend=F
    ) %>%
    layout(
      margin = list(t = 50),
      paper_bgcolor='rgb(255,255,255)', 
      plot_bgcolor='rgb(229,229,229)',
      xaxis = list(
        title = "",
        gridcolor = 'rgb(255,255,255)',
        showgrid = TRUE,
        showline = FALSE,
        showticklabels = TRUE,
        tickcolor = 'rgb(127,127,127)',
        ticks = 'outside',
        zeroline = FALSE,
        fixedrange = T,
        range = c(min(all_parks$date),max(all_parks$date)+1)
      ),
      yaxis = list(
        title = "Average Daily Park Visits",
        gridcolor = 'rgb(255,255,255)',
        showgrid = TRUE,
        showline = FALSE,
        showticklabels = TRUE,
        tickcolor = 'rgb(127,127,127)',
        ticks = 'outside',
        zeroline = FALSE,
        fixedrange = T,
        range = c(0,1000)
      ),
      annotations = list(
        list(
          xref = "x",
          yref = "y",
          x = "2020-03-16" %>% as.Date(),
          y = 1000,
          text = "A",
          xanchor = "center"
        ),
        list(
          xref = "x",
          yref = "y",
          x = "2020-03-20" %>% as.Date(),
          y = 1000,
          text = "B",
          xanchor = "center"
        ),
        list(
          xref = "x",
          yref = "y",
          x = "2020-04-01" %>% as.Date(),
          y = 1000,
          text = "C",
          xanchor = "center"
        ),
        list(
          xref = "x",
          yref = "y",
          x = "2020-04-08" %>% as.Date(),
          y = 1000,
          text = "D",
          xanchor = "center"
        )
      ),
      legend = list(
        x = 0.05, 
        y = 0.95,
        bgcolor = 'rgb(229,229,229)'
      )
    ) %>% 
    config(displayModeBar = F)
  
})

outputOptions(output, "parkgraph", priority = 10, suspendWhenHidden = F)
```

```{r, context="server"}
observeEvent(input$parkselect,{
    
  if(input$parkselect == ""){
    
    plotlyProxy("parkgraph") %>% 
      plotlyProxyInvoke("deleteTraces", list(8,9)) %>%
      plotlyProxyInvoke(
        "addTraces",
        list(
          type = "scatter",
          mode = "lines",
          x = c(isolate(input$parkdate),isolate(input$parkdate)),
          y = c(-10,1010),
          line = list(color = "rgb(39,128,227)"),
          name = "Current Map View",
          showlegend=F
        )
      ) %>% 
      plotlyProxyInvoke(
        "addTraces",
        list(
          type = "scatter",
          mode = "lines",
          x = c(isolate(input$parkdate),isolate(input$parkdate)),
          y = c(-10,1010),
          line = list(color = "rgb(39,128,227)"),
          name = "Current Map View",
          showlegend=F
        )
      )
    
  } else {
    
    data <-
      all_parks %>% 
      filter(location_name == input$parkselect) %>% 
      group_by(date) %>% 
      summarize(visit_counts = max(visit_counts, na.rm=T)) %>% 
      ungroup()
  
    plotlyProxy("parkgraph") %>% 
      plotlyProxyInvoke("deleteTraces", list(8,9)) %>%
      plotlyProxyInvoke(
        "addTraces",
        list(
          x = data$date,
          y = data$visit_counts,
          type = "scatter",
          mode = "lines",
          line = list(color = "rgb(227,39,39)"),
          name = paste0(input$parkselect),
          showlegend=T
        )
      ) %>% 
      plotlyProxyInvoke(
        "addTraces",
        list(
          type = "scatter",
          mode = "lines",
          x = c(isolate(input$parkdate),isolate(input$parkdate)),
          y = c(-10,1010),
          line = list(color = "rgb(39,128,227)"),
          name = "Current Map View",
          showlegend=F
        )
      )
    
  }

}, priority = 5)
```

```{r, context="server"}
observeEvent(input$parkdate,{
  
  if(isolate(input$parkselect) == ""){
    
    plotlyProxy("parkgraph") %>% 
      plotlyProxyInvoke("deleteTraces", list(8,9)) %>% 
      plotlyProxyInvoke(
        "addTraces",
        list(
          type = "scatter",
          mode = "lines",
          x = c(input$parkdate,input$parkdate),
          y = c(-10,1010),
          line = list(color = "rgb(39,128,227)"),
          name = "Current Map View",
          showlegend=F
        )
      ) %>% 
      plotlyProxyInvoke(
        "addTraces",
        list(
          type = "scatter",
          mode = "lines",
          x = c(input$parkdate,input$parkdate),
          y = c(-10,1010),
          line = list(color = "rgb(39,128,227)"),
          name = "Current Map View",
          showlegend=F
        )
      )
    
  } else {
    
    plotlyProxy("parkgraph") %>% 
      plotlyProxyInvoke("deleteTraces", list(9)) %>% 
      plotlyProxyInvoke(
        "addTraces",
        list(
          type = "scatter",
          mode = "lines",
          x = c(input$parkdate,input$parkdate),
          y = c(-10,1010),
          line = list(color = "rgb(39,128,227)"),
          name = "Current Map View",
          showlegend=F
        )
      )
    
  }
    
}, priority = 5)
```

### Full List of Park Closure Actions {data-height=500}

- Friday, March 13- announced closure of Happy Hollow Park & Zoo (located in Kelley Park) and the Action Sports Park (Bike Park/Skate Park) located in Lake Cunningham Regional Park.
- **(A)** Monday, March 16- Santa Clara County Shelter-in-Place Order
- **(B)** Friday, March 20- announced closure of all 286 City playgrounds (immediate signage went up the following weekend, followed later by better signage and snow fencing took about a week)
- Thursday, March 26- announced closure of Alum Rock Park and Communications Hill Staircase/Trail effective March 27
- **(C)** Wednesday, April 1- announced closure, effective immediately, of all dog parks; tennis, pickle ball, futsal, and basketball courts; outdoor gym equipment and playgrounds; picnic and barbecue areas; drinking fountains; restrooms; disc golf areas and sport fields (effective prior day with County Order); it took about three days to caution tape/snow fence and post signs at all these locations (1,000+ including park benches)
- **(D)** Wednesday, April 8- announced weekend (April 11-12) closure of the following:

| **Regional Park Closures** | **Neighborhood Parks: Parking Lot Closures (parks themselves will remain open)** |
|:----|:----|
| Overfelt Gardens Park<br>Kelley Park<br>Almaden Lake Park<br>Lake Cunningham Park<br>Edenvale Garden Park<br>Municipal Rose Garden<br>Alum Rock Park<br>Emma Prusch Farm Park<br>Guadalupe Oak Grove | Canyon Creek Park<br>Cataldi Park<br>Flickinger Park<br>Fowler Creek Park<br>Guadalupe Gardens<br>Houge Park<br>Kirk Park<br>Lone Bluff<br>Los Paseos<br>Penitencia Creek Park<br>Ramac Park<br>Ryland Park<br>San Antonio Tot Lot<br>Silver Creek Linear Park & Picnic Area<br>Starbird Park<br>Tamien Park<br>Vista Montana Park<br>Vista Park<br>Watson Park |

- Friday, April 24- announced that violations of park rules or unauthorized entry of closed areas in parks is being enforced with fines of \$100-\$500; also more visual signs mentioning fines were placed in key locations this weekend (April 25-26).

Demographics
=====================================

Column
-------------------------------------

### Key Insights From Demographic Data

1. **Higher income earners seem to be able to shelter in place at higher rates than lower income earners**. This could be due to unique challenges that lower income residents may face when attempting to shelter in place, or could be due to a higher percentage of essential workers residing in lower income block groups. 

2. **Block groups with higher percentages of Spanish speaking residents appear to have lower social distancing compliance**. 

3. **Block groups with higher percentages of Asian language- and Pacific Islander language-speaking residents seem to have higher social distancing compliance**. However, this census classification does not account for the diversity of Asian and Pacific Islander communities in San Jose. A more granular dataset would refine this analysis. 

Column {.tabset .tabset-fade}
-----------------------------------------------------------------------

### Income

```{r}
fig_ami <- 
  plot_ly (sj_dem_distancing_combined) %>%
    add_trace(
      x = ~`ami_% over 100,000`, 
      y = ~`% leaving home`, 
      frame = ~`Before or After Shelter-in-Place`, 
      type = 'scatter', 
      mode = 'markers', 
      showlegend = F
    ) %>% 
    add_trace(
      x = ~`ami_% over 100,000`,
      y = ~ami_trendline,
      type = 'scatter',
      mode = 'lines',
      line = list(size = 5, color = 'rgba(255, 165, 0, 1)'),
      frame = ~`Before or After Shelter-in-Place`,
      showlegend = F
    ) %>% 
  animation_button(visible = F) %>%
  animation_slider(
    pad = list(t =75),
    currentvalue = list(visible=F)
  ) %>% 
  layout(
    xaxis = list(title = '% of households making over $100,000'), 
    yaxis = list(title = '% leaving home'),
    margin = list(l = 75,r = 75)
  ) %>% 
  config(displayModeBar = F)

fig_ami
```

### Spanish Language

```{r}
fig_spanish <- 
  plot_ly (sj_dem_distancing_combined) %>%
    add_trace(
      x = ~`% not speaking spanish`, 
      y = ~`% leaving home`, 
      frame = ~`Before or After Shelter-in-Place`, 
      type = 'scatter', 
      mode = 'markers', 
      showlegend = F
    ) %>% 
    add_trace(
      x = ~`% not speaking spanish`,
      y = ~spanish_trendline,
      type = 'scatter',
      mode = 'lines',
      line = list(size = 5, color = 'rgba(255, 165, 0, 1)'),
      frame = ~`Before or After Shelter-in-Place`,
      showlegend = F
    ) %>% 
  animation_button(visible = F) %>%
  animation_slider(
    pad = list(t =75),
    currentvalue = list(visible=F)
  ) %>% 
  layout(
    xaxis = list(title = '% NOT speaking Spanish'), 
    yaxis = list(title = '% leaving home'),
    margin = list(l = 75,r = 75)
  ) %>% 
  config(displayModeBar = F)

fig_spanish
```

### API Language

```{r}
fig_api <- 
  plot_ly (sj_dem_distancing_combined) %>%
    add_trace(
      x = ~`% speaking api`, 
      y = ~`% leaving home`, 
      frame = ~`Before or After Shelter-in-Place`, 
      type = 'scatter', 
      mode = 'markers', 
      showlegend = F
    ) %>% 
    add_trace(
      x = ~`% speaking api`,
      y = ~api_trendline,
      type = 'scatter',
      mode = 'lines',
      line = list(size = 5, color = 'rgba(255, 165, 0, 1)'),
      frame = ~`Before or After Shelter-in-Place`,
      showlegend = F
    ) %>% 
  animation_button(visible = F) %>%
  animation_slider(
    pad = list(t =75),
    currentvalue = list(visible=F)
  ) %>% 
  layout(
    xaxis = list(title = '% speaking Asian or Pacific Islander Language'), 
    yaxis = list(title = '% leaving home'),
    margin = list(l = 75,r = 75)
  ) %>% 
  config(displayModeBar = F)

fig_api
```

### Elderly

```{r}
fig_elderly <- 
  plot_ly (sj_dem_distancing_combined) %>%
    add_trace(
      x = ~`percent elderly`, 
      y = ~`% leaving home`, 
      frame = ~`Before or After Shelter-in-Place`, 
      type = 'scatter', 
      mode = 'markers', 
      showlegend = F
    ) %>% 
    add_trace(
      x = ~`percent elderly`,
      y = ~elderly_trendline,
      type = 'scatter',
      mode = 'lines',
      line = list(size = 5, color = 'rgba(255, 165, 0, 1)'),
      frame = ~`Before or After Shelter-in-Place`,
      showlegend = F
    ) %>% 
  animation_button(visible = F) %>%
  animation_slider(
    pad = list(t =75),
    currentvalue = list(visible=F)
  ) %>% 
  layout(
    xaxis = list(title = '% elderly'), 
    yaxis = list(title = '% leaving home'),
    margin = list(l = 75,r = 75)
  ) %>% 
  config(displayModeBar = F)

fig_elderly
```

### Youth

```{r}
fig_young <- 
  plot_ly (sj_dem_distancing_combined) %>%
    add_trace(
      x = ~`percent less than 30`, 
      y = ~`% leaving home`, 
      frame = ~`Before or After Shelter-in-Place`, 
      type = 'scatter', 
      mode = 'markers', 
      showlegend = F
    ) %>% 
    add_trace(
      x = ~`percent less than 30`,
      y = ~young_trendline,
      type = 'scatter',
      mode = 'lines',
      line = list(size = 5, color = 'rgba(255, 165, 0, 1)'),
      frame = ~`Before or After Shelter-in-Place`,
      showlegend = F
    ) %>% 
  animation_button(visible = F) %>%
  animation_slider(
    pad = list(t =75),
    currentvalue = list(visible=F)
  ) %>% 
  layout(
    xaxis = list(title = '% younger than 30'), 
    yaxis = list(title = '% leaving home'),
    margin = list(l = 75,r = 75)
  ) %>% 
  config(displayModeBar = F)

fig_young
```